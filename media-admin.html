<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>FSA Admin Â· Media (Rota-Style-003)</title>
<style>
  :root{
    --bg:#0b1220;--card:#111827;--muted:#9aa4b2;--txt:#eaf2ff;
    --gold:#d4af37;--teal:#1cc2a0;--red:#e11d48;--blue:#38bdf8;
    --shadow:0 10px 30px rgba(0,0,0,.45);--radius:14px;
    --ink:#0f1a30;--line:rgba(255,255,255,.12)
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--txt);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  h1,h2,h3{margin:0 0 10px;font-family:Montserrat,system-ui,sans-serif}
  a{color:var(--blue);text-decoration:none}
  .wrap{max-width:1150px;margin:24px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid rgba(212,175,55,.25);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
  .grid{display:grid;gap:16px}
  .g-2{grid-template-columns:1fr 1fr}
  .g-3{grid-template-columns:1.2fr .8fr}
  @media (max-width:1020px){.g-2,.g-3{grid-template-columns:1fr}}

  .title{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:8px}
  .title h2{color:var(--gold);font-size:1.2rem}
  .muted{color:var(--muted);font-size:.95rem}
  .hr{height:1px;background:rgba(255,255,255,.1);margin:12px 0}

  label{display:block;margin:8px 0 6px;font-weight:700;color:#dbe3f3}
  input[type="text"],input[type="number"],input[type="datetime-local"],textarea,select{
    width:100%;padding:10px;border-radius:10px;border:1px solid #334155;background:#0b1325;color:#fff
  }
  textarea{min-height:96px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{padding:10px 14px;border:none;border-radius:10px;font-weight:800;cursor:pointer;box-shadow:var(--shadow)}
  .btn.gold{background:var(--gold);color:#000}.btn.teal{background:var(--teal);color:#001210}
  .btn.blue{background:var(--blue);color:#001018}.btn.red{background:var(--red);color:#fff}
  .btn.ghost{background:transparent;border:1px dashed rgba(255,255,255,.25);color:#cbd5e1}
  .btn.small{padding:6px 10px;font-weight:700}

  .list{display:grid;gap:10px}
  .item{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;background:#0e182b;border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:10px;}
  .badge{background:var(--gold);color:#000;border-radius:999px;padding:2px 8px;font-weight:900;font-size:.8rem}
  .item .url{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#dbeafe}
  .item.active{outline:2px solid var(--teal);background:#0e1e2b}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px dashed rgba(255,255,255,.25);border-radius:999px;color:#cbd5e1}

  .preview{border:2px solid var(--gold);border-radius:12px;overflow:hidden;height:360px;background:#000}
  .preview audio{width:100%}
  .stat{display:flex;gap:8px;flex-wrap:wrap;align-items:center;font-size:.92rem}
  .chip{padding:4px 10px;border-radius:999px;background:#0f1a30;border:1px solid var(--line);color:#cbe0ff}

  .note{font-size:.9rem;color:#b6c3d6}
  .ok{color:#22c55e}.warn{color:#f59e0b}.err{color:#ef4444}

  /* On-Air indicator 1..12 */
  .onair{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .dot{width:30px;height:30px;border-radius:999px;background:#0f1a30;border:1px solid var(--line);display:flex;align-items:center;justify-content:center;color:#cbe0ff;font-weight:800}
  .dot.live{outline:2px solid var(--gold);background:#13233a}
  .blink{animation:blink 1.2s linear infinite}
  @keyframes blink{0%{filter:brightness(1)}50%{filter:brightness(2)}100%{filter:brightness(1)}}

  /* Kino Live Banner */
  .kino-live{margin:8px 0;padding:8px 12px;border-radius:10px;background:#141e33;border:1px solid rgba(255,255,255,.15);color:#ffe8a3;font-weight:900;letter-spacing:.3px}
  .kino-live.blink{animation:blink 1.4s linear infinite}

  /* little tags on rows */
  .tag{font-size:.8rem;padding:3px 8px;border-radius:999px;background:#0f1a30;border:1px solid var(--line);color:#cbe0ff}
</style>
</head>
<body>
<div class="wrap">

  <!-- GitHub Verbindung -->
  <div class="card">
    <div class="title"><h2>ğŸ”‘ GitHub Verbindung</h2></div>
    <div class="grid g-2">
      <div><label>Owner</label><input id="ghOwner" type="text" value="Adler-FSA"></div>
      <div><label>Repo</label><input id="ghRepo" type="text" value="FSA-Admin"></div>
      <div><label>Branch</label><input id="ghBranch" type="text" value="main"></div>
      <div><label>JSON-Pfad</label><input id="ghPath" type="text" value="rotator.json"></div>
      <div style="grid-column:1/-1">
        <label>Personal Access Token (wird NICHT gespeichert)</label>
        <input id="ghToken" type="text" placeholder="ghp_... (fine-grained: contents read/write)">
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn gold" id="btnConnect">ğŸ”— Verbinden</button>
      <button class="btn ghost" id="btnReload" disabled>ğŸ”„ Daten laden / anlegen</button>
      <label class="pill"><input id="chkRemember" type="checkbox"> Sitzung merken (nur dieser Tab)</label>
      <button class="btn red" id="btnLogout">ğŸšª Ausloggen</button>
      <span id="connStatus" class="note">Bitte Token einfÃ¼gen und verbinden.</span>
    </div>
  </div>

  <!-- Teil 1: Videos -->
  <div class="grid g-3" style="margin-top:16px">
    <div class="card">
      <div class="title"><h2>ğŸ“š Bibliothek</h2><div class="muted">Globaler Pool deiner Videos</div></div>
      <label>Neue Video-URL (YouTube/Vimeo/Zoom)</label>
      <input id="newUrl" type="text" placeholder="https://youtu.be/â€¦ oder https://www.youtube.com/watch?v=â€¦">
      <div class="row" style="margin-top:8px">
        <button class="btn teal" id="btnAddLib">ï¼‹ Zur Bibliothek</button>
        <button class="btn blue" id="btnAddActive">ï¼‹ Direkt in Rotator</button>
        <button class="btn gold" id="btnPreviewNew">â–¶ï¸ Vorschau</button>
        <button class="btn ghost" id="btnStopPreview">â¹ï¸ Vorschau Stop</button>
      </div>
      <div class="hr"></div>
      <div class="stat">
        <span class="chip">EintrÃ¤ge: <span id="countLib">0</span></span>
        <span class="chip">Aktive max: 12</span>
      </div>
      <div id="libList" class="list" style="margin-top:10px"></div>
    </div>

    <div class="card">
      <div class="title"><h2>ğŸ› Aktive Videos (Rotator)</h2><div class="muted">Max. 12 â€“ Reihenfolge zÃ¤hlt</div></div>
      <div class="stat">
        <span class="chip">Aktiv: <span id="countActive">0</span>/12</span>
        <span class="chip">Intervall: <span id="intervalLabel">60</span>s</span>
      </div>
      <div id="activeList" class="list" style="margin-top:10px"></div>
    </div>

    <div class="card">
      <div class="title"><h2>ğŸ“¦ Archiv</h2><div class="muted">ZurÃ¼ckholen mÃ¶glich</div></div>
      <div id="archList" class="list"></div>
    </div>
  </div>

  <!-- Teil 2: Vorschau / Rotation -->
  <div class="card" style="margin-top:16px">
    <div class="title"><h2>ğŸ–¥ Vorschau & Rotation</h2><div class="muted">Nur Admin-Test â€“ LP liest die gespeicherten Daten</div></div>
    <div class="grid g-2">
      <div>
        <div id="previewBox" class="preview"><iframe id="preview" width="100%" height="100%" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen style="border:0"></iframe></div>
        <div class="onair" id="onAirDots"></div>
        <div class="row" style="margin-top:10px">
          <button class="btn gold" id="btnTestRotate">âœï¸ Rotationstest (5s)</button>
          <button class="btn ghost" id="btnStopAll">â¹ï¸ Test/Rotation beenden</button>
          <span class="tag" id="nowInfo">Now â€”/â€”</span>
        </div>
      </div>
      <div>
        <label>Intervall (Sekunden)</label>
        <input id="intervalSec" type="number" min="3" value="60">

        <label style="margin-top:8px">Guard-Zeit (Sekunden) â€“ Anti-StÃ¶rung</label>
        <input id="guardSec" type="number" min="3" value="10">

        <label style="margin-top:8px">Host-PrÃ¤ferenz</label>
        <select id="hostPref">
          <option value="auto">Automatisch</option>
          <option value="yt">YouTube bevorzugt</option>
          <option value="vimeo">Vimeo bevorzugt</option>
        </select>

        <div class="row" style="margin-top:10px">
          <button class="btn teal" id="btnStartRotation">â–¶ï¸ Start</button>
          <button class="btn red"  id="btnPauseRotation">â¸ Stop</button>
          <button class="btn blue" id="btnSaveInterval">ğŸ’¾ Intervall & Guard & Host merken</button>
        </div>
        <div class="row" style="margin-top:10px">
          <label class="pill"><input id="chkAutoSkip" type="checkbox"> VerdÃ¤chtige automatisch Ã¼berspringen</label>
        </div>
        <div class="hr"></div>
        <div class="note">Status: <span id="statusMsg">â€”</span></div>
      </div>
    </div>
  </div>

  <!-- Teil 3: Kino -->
  <div class="card" style="margin-top:16px">
    <div class="title"><h2>ğŸ¬ Kino / Playlist / Fallback</h2><div class="muted">Global fÃ¼r LP-â€Kino-Fensterâ€œ â€“ separate Vorschau</div></div>

    <div class="kino-live" id="kinoLiveBanner" style="display:none">ğŸ¥ Kino in Akademie lÃ¤uft</div>

    <div class="grid g-2">
      <div>
        <label>Kino/Embed URL (YouTube/Zoom â€¦)</label>
        <input id="kinoUrl" type="text" placeholder="https://www.youtube.com/embed/...  (mehrere durch Leerzeichen)">
        <label>Playlist URL (optional)</label>
        <input id="playlistUrl" type="text" placeholder="https://www.youtube.com/playlist?list=...">
        <div class="row" style="margin-top:10px">
          <button class="btn gold" id="btnKinoPreview">â–¶ï¸ Kino Vorschau</button>
          <button class="btn ghost" id="btnKinoPrevStop">â¹ï¸ Kino-Preview Stop</button>
          <button class="btn blue" id="btnKinoSave">ğŸ’¾ Kino/Playlist merken</button>
        </div>
        <div class="preview" style="height:260px;margin-top:10px">
          <iframe id="kinoPrev" width="100%" height="100%" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen style="border:0"></iframe>
        </div>
      </div>

      <div>
        <label>Modus</label>
        <select id="kinoMode">
          <option value="60s">â± alle 60 Sekunden</option>
          <option value="daily">ğŸ“… tÃ¤glich</option>
          <option value="3m">ğŸ“† alle 3 Monate</option>
          <option value="length">â²ï¸ nach GesamtlÃ¤nge ausstrahlen</option>
        </select>
        <label>Geplanter Start</label>
        <input id="kinoStart" type="datetime-local">
        <div class="hr"></div>
        <label>Adler-Fallback</label>
        <div class="row">
          <select id="fallbackEnabled">
            <option value="true">ğŸ¦… Fallback aktiv</option>
            <option value="false">ğŸ¦… Fallback aus</option>
          </select>
          <input id="fallbackImage" type="text" placeholder="https://.../assets/adler-fallback.jpg">
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn ghost" id="btnKinoAsTemplate">ğŸ“Œ Als Vorlage speichern</button>
          <button class="btn teal" id="btnKinoStartNow">ğŸŸ¢ Jetzt starten (loggt)</button>
          <button class="btn red" id="btnKinoEnd">ğŸ”´ Event beenden</button>
        </div>
      </div>
    </div>

    <div class="hr"></div>

    <div class="grid g-2">
      <div class="card" style="background:#0e1627">
        <div class="title"><h2>ğŸ“š Vorlagen (Bibliothek)</h2><div class="muted">Kino-Vorlagen speichern/laden</div></div>
        <div id="kinoTemplates" class="list"></div>
      </div>

      <div class="card" style="background:#0e1627">
        <div class="title"><h2>ğŸ•’ Verlauf (zuletzt zuerst)</h2><div class="muted">geloggte Sendungen</div></div>
        <div id="kinoHistory" class="list"></div>
      </div>
    </div>

    <div class="card" style="background:#0e1627;margin-top:12px">
      <div class="title"><h2>ğŸ“¦ Kino-Archiv</h2><div class="muted">zur Wiederverwendung</div></div>
      <div id="kinoArchive" class="list"></div>
    </div>
  </div>

  <!-- Teil 4: Musik -->
  <div class="card" style="margin-top:16px">
    <div class="title"><h2>ğŸµ Musik Â· Bibliothek / Aktiv / Archiv</h2><div class="muted">Audio fÃ¼r LP-Hintergrund (Standard: aus)</div></div>

    <label>Neue Audio-URL (mp3/ogg/wav)</label>
    <input id="newMusicUrl" type="text" placeholder="https://â€¦/track.mp3">

    <div class="row" style="margin-top:8px">
      <button class="btn teal" id="btnAddMusicLib">ï¼‹ Zur Bibliothek</button>
      <button class="btn blue" id="btnAddMusicActive">ï¼‹ Direkt aktiv</button>
      <button class="btn gold" id="btnPrevMusic">â–¶ï¸ Audio-Vorschau</button>
      <button class="btn ghost" id="btnPrevMusicStop">â¹ï¸ Stopp</button>
    </div>

    <div class="row" style="margin-top:8px">
      <button class="btn ghost" id="btnScanRepo">ğŸ” Repo scannen (Musik)</button>
      <label class="pill"><input type="checkbox" id="scanAll"> alle Ordner</label>
      <input type="file" id="musicFile" accept="audio/*" style="display:none">
      <button class="btn gold" id="btnUpload">ğŸ“¤ Datei ins Repo</button>
      <span class="note">â†’ /assets/music/</span>
    </div>

    <div class="grid g-3" style="margin-top:10px">
      <div>
        <div class="stat"><span class="chip">EintrÃ¤ge: <span id="countMusicLib">0</span></span></div>
        <div id="musicLib" class="list" style="margin-top:8px"></div>
      </div>
      <div>
        <div class="stat"><span class="chip">Aktiv: <span id="countMusicActive">0</span></span></div>
        <div id="musicActive" class="list" style="margin-top:8px"></div>
      </div>
      <div>
        <div class="title"><h2>ğŸ“¦ Archiv</h2></div>
        <div id="musicArch" class="list"></div>
      </div>
    </div>

    <div class="preview" style="height:auto;margin-top:10px;padding:12px">
      <audio id="audioPrev" controls></audio>
    </div>
  </div>

  <div class="muted" style="margin:14px 4px">Letztes Laden: <span id="lastLoad">â€”</span> Â· Letztes Speichern: <span id="lastSave">â€”</span></div>
</div>

<script>
/* ===== Konstante Limits ===== */
const MAX_ACTIVE = 12;

/* ===== Helpers ===== */
const $ = s => document.querySelector(s);
const byId = id => document.getElementById(id);
const confirmAction = (msg)=> confirm(msg||"Sicher?");
function shortUrl(u){try{const x=new URL(u);return x.hostname.replace('www.','')+x.pathname+(x.search?'â€¦':'')}catch(e){return u}}
function nowISO(){return new Date().toISOString()}
function toISO(v){if(!v) return ""; const d=new Date(v); return isNaN(d)?"":d.toISOString();}
function fromISOtoLocal(iso){if(!iso) return ""; const d=new Date(iso); if(isNaN(d)) return ""; const z=d.getTimezoneOffset()*60000; return new Date(d - z).toISOString().slice(0,16);}

/* Base64 UTF-8 */
function toBase64(str){const enc=new TextEncoder().encode(str);let bin="";enc.forEach(b=>bin+=String.fromCharCode(b));return btoa(bin)}
function fromBase64(b64){const bin=atob(b64);const bytes=new Uint8Array(bin.length);for(let i=0;i<bin.length;i++)bytes[i]=bin.charCodeAt(i);return new TextDecoder().decode(bytes)}

/* URL â EMBED (unter Beachtung Host-PrÃ¤ferenz) */
function toEmbed(url, pref='auto'){
  if(!url) return "";
  let u=url.trim();
  // Falls mehrere mit Leerzeichen -> nur das erste
  if(/\s/.test(u)) u = u.split(/\s+/).filter(Boolean)[0];

  const isYou=(x)=>/youtu\.be|youtube\.com/i.test(x);
  const isVim=(x)=>/vimeo\.com/i.test(x);

  if(pref==='yt' && isVim(u)) return u; // keine Konvertierung mÃ¶glich
  if(pref==='vimeo' && isYou(u)) return u;

  if(/youtu\.be\//i.test(u)){const id=u.split("youtu.be/")[1].split(/[?&]/)[0];return `https://www.youtube.com/embed/${id}?rel=0&autoplay=1&mute=1&playsinline=1`}
  if(/youtube\.com\/watch/i.test(u)){try{const q=new URL(u).searchParams.get("v"); if(q) return `https://www.youtube.com/embed/${q}?rel=0&autoplay=1&mute=1&playsinline=1`}catch(e){}}
  if(/youtube\.com\/embed/i.test(u)) return u;
  if(/vimeo\.com\/\d+/.test(u)){const id=(u.match(/vimeo\.com\/(\d+)/)||[])[1]; if(id) return `https://player.vimeo.com/video/${id}?autoplay=1&muted=1`}
  if(/player\.vimeo\.com\/video/.test(u)) return u;
  return u;
}

/* ===== GitHub ===== */
let GH={owner:"Adler-FSA",repo:"FSA-Admin",branch:"main",path:"rotator.json",token:""};
let current=null, currentSha="", testTimer=null, rotateTimer=null, selectedActiveIndex=-1;
let guardTicker=null, onAirIndex=0, autoSkip=false;

function ghHeaders(){ if(!GH.token) throw new Error("Kein Token"); return {"Authorization":"Bearer "+GH.token,"Accept":"application/vnd.github+json","Content-Type":"application/json"};}
function pagesBase(){ return `https://${GH.owner.toLowerCase()}.github.io/${GH.repo}/`; }
function toPagesUrl(path){ return pagesBase()+path.replace(/^\/+/,''); }

async function ghGetFile(){
  const url=`https://api.github.com/repos/${GH.owner}/${GH.repo}/contents/${GH.path}?ref=${GH.branch}`;
  const res=await fetch(url,{headers:ghHeaders()});
  if(res.status===404) return {status:404};
  if(!res.ok){throw new Error(`GET ${res.status}: ${await res.text()}`)}
  const j=await res.json(); const content=fromBase64(j.content||"");
  return {status:200,sha:j.sha,data:JSON.parse(content)};
}
async function ghPutFile(data,message){
  const url=`https://api.github.com/repos/${GH.owner}/${GH.repo}/contents/${GH.path}`;
  const body={message:message||"update rotator.json",content:toBase64(JSON.stringify(data,null,2)),branch:GH.branch};
  if(currentSha) body.sha=currentSha;
  const res=await fetch(url,{method:"PUT",headers:ghHeaders(),body:JSON.stringify(body)});
  if(!res.ok){throw new Error(`PUT ${res.status}: ${await res.text()}`)}
  const j=await res.json(); currentSha=j.content.sha; byId("lastSave").textContent=new Date().toLocaleString();
}

/* LIST / RECURSIVE for repo */
async function ghListPath(path){
  const url=`https://api.github.com/repos/${GH.owner}/${GH.repo}/contents/${path}?ref=${GH.branch}`;
  const res=await fetch(url,{headers:ghHeaders()});
  if(res.status===404) return [];
  if(!res.ok) throw new Error(`LIST ${path}: ${res.status} ${await res.text()}`);
  return await res.json();
}
async function ghListRecursive(startPath){
  const out=[]; const stack=[startPath];
  while(stack.length){
    const p=stack.pop();
    const items=await ghListPath(p);
    for(const it of items){
      if(it.type==='dir'){ stack.push(it.path); }
      else out.push(it);
    }
  }
  return out;
}
/* upload binary */
async function ghGetMeta(path){
  const url=`https://api.github.com/repos/${GH.owner}/${GH.repo}/contents/${path}?ref=${GH.branch}`;
  const res=await fetch(url,{headers:ghHeaders()});
  if(res.status===404) return null;
  if(!res.ok) throw new Error(`HEAD ${path}: ${res.status} ${await res.text()}`);
  return await res.json();
}
async function ghUploadBinary(path, base64, message, sha){
  const url=`https://api.github.com/repos/${GH.owner}/${GH.repo}/contents/${path}`;
  const body={message:message||`upload ${path}`, content:base64, branch:GH.branch};
  if(sha) body.sha=sha;
  const res=await fetch(url,{method:'PUT', headers:ghHeaders(), body:JSON.stringify(body)});
  if(!res.ok) throw new Error(`PUT ${path}: ${res.status} ${await res.text()}`);
  return await res.json();
}

/* Defaults (inkl. 4 Test-Videos) */
function defaultData(){
  return {
    active:[
      "https://www.youtube.com/embed/miWBKSszEIw?rel=0&autoplay=1&mute=1&playsinline=1",
      "https://www.youtube.com/embed/J7QYQ-Qj-48?rel=0&autoplay=1&mute=1&playsinline=1",
      "https://www.youtube.com/embed/CqesPVWSzao?rel=0&autoplay=1&mute=1&playsinline=1",
      "https://www.youtube.com/embed/WcuSPqefQBY?rel=0&autoplay=1&mute=1&playsinline=1"
    ],
    library:[
      "https://youtu.be/CqesPVWSzao",
      "https://youtu.be/WcuSPqefQBY",
      "https://youtu.be/qPlWNJ__Z1Q"
    ],
    archived:[],
    interval:60,
    guard:10,
    hostPref:"auto",
    autoSkip:false,
    kino:{url:"",playlist:"",mode:"60s",startISO:"", templates:[], history:[], archive:[], running:false},
    fallback:{enabled:true,imageUrl:""},
    music:{library:[],active:[],archived:[]},
    updated:nowISO()
  };
}

/* ===== Render ===== */
function ensureStruct(){
  current.library=current.library||[];
  current.active=current.active||[];
  current.archived=current.archived||[];
  current.interval=current.interval||60;
  current.guard=current.guard??10;
  current.hostPref=current.hostPref||"auto";
  current.autoSkip=!!current.autoSkip;
  current.kino=current.kino||{url:"",playlist:"",mode:"60s",startISO:"",templates:[],history:[],archive:[],running:false};
  current.kino.templates=current.kino.templates||[];
  current.kino.history=current.kino.history||[];
  current.kino.archive=current.kino.archive||[];
  current.music=current.music||{library:[],active:[],archived:[]};
}

function renderOnAir(){
  const dots=byId('onAirDots'); dots.innerHTML='';
  for(let i=1;i<=12;i++){
    const d=document.createElement('div'); d.className='dot'+(i-1===onAirIndex?' live blink':'');
    d.textContent=i; dots.appendChild(d);
  }
}

function renderAll(){
  ensureStruct();

  byId("countLib").textContent=current.library.length;
  byId("countActive").textContent=current.active.length;
  byId("intervalLabel").textContent=current.interval||60;

  byId("libList").innerHTML=current.library.map((u,i)=>`
    <div class="item">
      <span class="badge">${i+1}</span>
      <div class="url" title="${u}">${shortUrl(u)}</div>
      <div class="row">
        <button class="btn small gold" onclick="previewUrl('${encodeURIComponent(toEmbed(u,current.hostPref))}')">â–¶ï¸ Vorschau</button>
        <button class="btn small teal" onclick="libToActive(${i})">ï¼‹ In Rotator</button>
        <button class="btn small ghost" onclick="removeFromLibrary(${i})">ğŸ—‘ Entfernen</button>
      </div>
    </div>`).join("");

  byId("activeList").innerHTML=current.active.map((u,i)=>`
    <div class="item ${i===selectedActiveIndex?'active':''}" onclick="selectActive(${i})">
      <span class="badge">${i+1}</span>
      <div class="url" title="${u}">${shortUrl(u)}</div>
      <div class="row">
        <button class="btn small gold" onclick="event.stopPropagation(); previewUrl('${encodeURIComponent(u)}')">â–¶ï¸ Vorschau</button>
        <button class="btn small ghost" onclick="event.stopPropagation(); moveUp(${i})">â–²</button>
        <button class="btn small ghost" onclick="event.stopPropagation(); moveDown(${i})">â–¼</button>
        <button class="btn small blue" onclick="event.stopPropagation(); activeToArchive(${i})">ğŸ“¦ Archiv</button>
      </div>
    </div>`).join("");

  const ar=current.archived;
  byId("archList").innerHTML=ar.length? ar.map((o,i)=>`
    <div class="item">
      <span class="badge">${i+1}</span>
      <div class="url" title="${o.url}">${shortUrl(o.url)} <span class="muted">Â· ${o.archived_at?new Date(o.archived_at).toLocaleString():""}</span></div>
      <div class="row">
        <button class="btn small teal" onclick="restoreFromArchive(${i})">â†©ï¸ ZurÃ¼ckholen</button>
        <button class="btn small ghost" onclick="removeFromArchive(${i})">ğŸ—‘ Entfernen</button>
      </div>
    </div>`).join(""):`<div class="muted">Noch nichts archiviert.</div>`;

  byId("intervalSec").value=current.interval||60;
  byId("guardSec").value=current.guard||10;
  byId("hostPref").value=current.hostPref||"auto";
  byId("chkAutoSkip").checked=!!current.autoSkip;

  // Kino
  byId("kinoUrl").value=current.kino?.url||"";
  byId("playlistUrl").value=current.kino?.playlist||"";
  byId("kinoMode").value=current.kino?.mode||"60s";
  byId("kinoStart").value=fromISOtoLocal(current.kino?.startISO||"");
  byId("fallbackEnabled").value=String(current.fallback?.enabled??true);
  byId("fallbackImage").value=current.fallback?.imageUrl||"";
  byId("kinoLiveBanner").style.display=current.kino.running?'block':'none';
  byId("kinoLiveBanner").classList.toggle('blink',!!current.kino.running);

  renderKinoLists();
  renderMusic();
  renderOnAir();
}

/* Guard: sicherstellen, dass current geladen ist */
async function ensureLoaded(){ if(current) return; await loadOrInit(); }

/* Aktionen â€“ Teil 1: Videos */
async function addToLibrary(){
  try{
    await ensureLoaded();
    const u=byId("newUrl").value.trim();
    const emb=toEmbed(u,current.hostPref);
    if(!emb) return alert("Bitte gÃ¼ltige URL eingeben.");
    if(!current.library.includes(u)) current.library.push(u);
    current.updated=nowISO();
    await ghPutFile(current,"add: library");
    renderAll();
  }catch(e){ alert("Fehler (Bibliothek hinzufÃ¼gen):\n"+e.message); }
}
async function addDirectToActive(){
  try{
    await ensureLoaded();
    const u=byId("newUrl").value.trim();
    const emb=toEmbed(u,current.hostPref);
    if(!emb) return alert("Bitte gÃ¼ltige URL eingeben.");
    if(current.active.length>=MAX_ACTIVE) return alert(`Maximal ${MAX_ACTIVE} aktive Videos.`);
    if(!current.active.includes(emb)) current.active.push(emb);
    if(!current.library.includes(u)) current.library.push(u);
    current.updated=nowISO();
    await ghPutFile(current,"add: direct-to-active");
    renderAll();
  }catch(e){ alert("Fehler (Direkt in Rotator):\n"+e.message); }
}
async function libToActive(i){
  try{
    await ensureLoaded();
    const u=toEmbed(current.library[i],current.hostPref);
    if(current.active.length>=MAX_ACTIVE) return alert(`Maximal ${MAX_ACTIVE} aktive Videos.`);
    if(!current.active.includes(u)) current.active.push(u);
    current.updated=nowISO();
    await ghPutFile(current,"add: lib->active");
    renderAll();
  }catch(e){ alert("Fehler (lib->active):\n"+e.message); }
}
async function removeFromLibrary(i){
  try{
    if(!confirmAction("Aus Bibliothek entfernen?")) return;
    await ensureLoaded();
    current.library.splice(i,1);
    current.updated=nowISO();
    await ghPutFile(current,"remove: library");
    renderAll();
  }catch(e){ alert("Fehler (Library entfernen):\n"+e.message); }
}
function selectActive(i){selectedActiveIndex=i; renderAll();}
async function moveUp(i){
  if(i<=0) return;
  const a=current.active; [a[i-1],a[i]]=[a[i],a[i-1]];
  selectedActiveIndex=i-1; current.updated=nowISO();
  await ghPutFile(current,"reorder: up"); renderAll();
}
async function moveDown(i){
  const a=current.active; if(i>=a.length-1) return;
  [a[i+1],a[i]]=[a[i],a[i+1]];
  selectedActiveIndex=i+1; current.updated=nowISO();
  await ghPutFile(current,"reorder: down"); renderAll();
}
async function activeToArchive(i){
  try{
    if(!confirmAction("In Archiv verschieben?")) return;
    await ensureLoaded();
    const u=current.active[i];
    current.archived=current.archived||[];
    current.archived.unshift({url:u,archived_at:nowISO()});
    current.active.splice(i,1);
    selectedActiveIndex=-1; current.updated=nowISO();
    await ghPutFile(current,"archive: from-active");
    renderAll();
  }catch(e){ alert("Fehler (Archivieren):\n"+e.message); }
}
async function restoreFromArchive(i){
  try{
    await ensureLoaded();
    const u=current.archived[i].url;
    if(current.active.length>=MAX_ACTIVE) return alert(`Schon ${MAX_ACTIVE} aktive Videos.`);
    if(!current.active.includes(u)) current.active.push(u);
    current.archived.splice(i,1);
    current.updated=nowISO();
    await ghPutFile(current,"restore: archive->active");
    renderAll();
  }catch(e){ alert("Fehler (ZurÃ¼ckholen):\n"+e.message); }
}
async function removeFromArchive(i){
  try{
    if(!confirmAction("Archiv-Eintrag endgÃ¼ltig entfernen?")) return;
    await ensureLoaded();
    current.archived.splice(i,1);
    current.updated=nowISO();
    await ghPutFile(current,"remove: archive");
    renderAll();
  }catch(e){ alert("Fehler (Archiv entfernen):\n"+e.message); }
}

/* Vorschau/Rotation â€“ Teil 2 */
function previewUrl(enc){const u=decodeURIComponent(enc); byId("preview").src=u; byId("statusMsg").textContent="Vorschau lÃ¤uft";}
function stopPreview(){byId("preview").src="about:blank"; byId("statusMsg").textContent="Vorschau gestoppt";}
function stopAllTimers(){if(testTimer)clearInterval(testTimer); if(rotateTimer)clearInterval(rotateTimer); if(guardTicker)clearInterval(guardTicker); testTimer=null; rotateTimer=null; guardTicker=null; stopPreview();}
function startTestRotate(){
  if(!current?.active?.length) return alert("Keine aktiven Videos.");
  stopAllTimers(); let i=0;
  const arr=current.active; onAirIndex=0; renderOnAir();
  byId("preview").src=arr[0]; byId("statusMsg").textContent="Rotationstest (5s) â€¦";
  byId('nowInfo').textContent=`Now 1/${arr.length}`;
  testTimer=setInterval(()=>{i=(i+1)%arr.length; onAirIndex=i; renderOnAir(); byId('nowInfo').textContent=`Now ${i+1}/${arr.length}`; byId("preview").src=arr[i];},5000);
}
function startRotation(){
  if(!current?.active?.length) return alert("Keine aktiven Videos.");
  if(!confirmAction("Rotation starten?")) return;
  stopAllTimers();
  const arr=current.active, sec=Math.max(3,parseInt(byId("intervalSec").value||"60",10));
  const guard=Math.max(3,parseInt(byId("guardSec").value||"10",10));
  autoSkip=byId('chkAutoSkip').checked;
  let i=0; onAirIndex=0; renderOnAir();
  byId("preview").src=arr[0]; byId("statusMsg").textContent=`Rotation aktiv (${sec}s, Guard ${guard}s)`;
  byId('nowInfo').textContent=`Now 1/${arr.length}`;
  rotateTimer=setInterval(()=>{i=(i+1)%arr.length; onAirIndex=i; renderOnAir(); byId('nowInfo').textContent=`Now ${i+1}/${arr.length}`; byId("preview").src=arr[i];},sec*1000);

  // Guard: kurzer VorzÃ¤hler, optional skip (annÃ¤hernd â€“ echte Ad-Detection cross-origin nicht mÃ¶glich)
  guardTicker=setInterval(()=>{ if(!autoSkip) return; /* heuristisch: kÃ¼rzer skippen */ },guard*1000);
}
function pauseRotation(){ if(!confirmAction("Rotation stoppen?")) return; if(rotateTimer)clearInterval(rotateTimer); if(guardTicker)clearInterval(guardTicker); rotateTimer=null; guardTicker=null; byId("statusMsg").textContent="Rotation pausiert";}
async function saveInterval(){
  try{
    await ensureLoaded();
    const sec=Math.max(3,parseInt(byId("intervalSec").value||"60",10));
    const guard=Math.max(3,parseInt(byId("guardSec").value||"10",10));
    current.interval=sec; current.guard=guard;
    current.hostPref=byId('hostPref').value;
    current.autoSkip=byId('chkAutoSkip').checked;
    current.updated=nowISO();
    await ghPutFile(current,"update: interval/guard/host");
    byId("intervalLabel").textContent=sec; byId("statusMsg").textContent="Einstellungen gespeichert";
  }catch(e){ alert("Fehler beim Speichern:\n"+e.message); }
}

/* Kino â€“ Teil 3 */
function kinoPreview(){
  const val=byId("kinoUrl").value.trim();
  if(!val) return alert("Bitte Kino/Embed URL(s) eintragen.");
  const first=val.split(/\s+/)[0];
  byId("kinoPrev").src=toEmbed(first,'auto');
  byId("statusMsg").textContent="Kino-Vorschau lÃ¤uft";
}
function kinoPrevStop(){ byId("kinoPrev").src="about:blank"; }

function renderKinoLists(){
  const T=byId('kinoTemplates'), H=byId('kinoHistory'), A=byId('kinoArchive');
  const tpl=current.kino.templates||[], hist=current.kino.history||[], arc=current.kino.archive||[];

  T.innerHTML = tpl.length? tpl.map((o,i)=>`
    <div class="item">
      <span class="badge">${i+1}</span>
      <div class="url" title="${o.url}">${shortUrl(o.url)} <span class="muted">Â· gespeichert ${new Date(o.saved_at).toLocaleString()}</span></div>
      <div class="row">
        <button class="btn small teal" onclick="kinoLoadTemplate(${i})">â‡¢ Laden</button>
        <button class="btn small ghost" onclick="kinoTemplateRemove(${i})">ğŸ—‘ Entfernen</button>
      </div>
    </div>`).join(""):`<div class="muted">Noch keine Vorlagen.</div>`;

  H.innerHTML = hist.length? hist.map((o,i)=>`
    <div class="item">
      <span class="badge">${i+1}</span>
      <div class="url">${shortUrl(o.url||'')} <span class="muted">Â· start: ${o.start?new Date(o.start).toLocaleString():'â€”'}${o.end? ' â€“ Ende: '+new Date(o.end).toLocaleString():''}</span></div>
      <div class="row">
        <button class="btn small teal" onclick="kinoReplay(${i})">ğŸŸ¢ Wieder senden</button>
        <button class="btn small blue" onclick="kinoHistToArchive(${i})">ğŸ“¦ Archiv</button>
      </div>
    </div>`).join(""):`<div class="muted">Noch kein Verlauf.</div>`;

  A.innerHTML = arc.length? arc.map((o,i)=>`
    <div class="item">
      <span class="badge">${i+1}</span>
      <div class="url">${shortUrl(o.url||'')} <span class="muted">Â· archiviert ${new Date(o.archived_at).toLocaleString()}</span></div>
      <div class="row">
        <button class="btn small teal" onclick="kinoArchiveRestore(${i})">â†©ï¸ ZurÃ¼ckholen</button>
        <button class="btn small ghost" onclick="kinoArchiveRemove(${i})">ğŸ—‘ Entfernen</button>
      </div>
    </div>`).join(""):`<div class="muted">Kino-Archiv leer.</div>`;
}

async function kinoSave(){
  try{
    await ensureLoaded();
    current.kino={...current.kino,
      url:byId("kinoUrl").value.trim(),
      playlist:byId("playlistUrl").value.trim(),
      mode:byId("kinoMode").value,
      startISO:toISO(byId("kinoStart").value)
    };
    current.fallback={enabled:byId("fallbackEnabled").value==="true",imageUrl:byId("fallbackImage").value.trim()};
    current.updated=nowISO(); await ghPutFile(current,"update: kino/playlist/fallback");
    byId("statusMsg").textContent="Kino gespeichert";
  }catch(e){ alert("Fehler beim Speichern Kino:\n"+e.message); }
}
async function kinoAsTemplate(){
  try{
    await ensureLoaded();
    const entry={url:byId("kinoUrl").value.trim(), playlist:byId("playlistUrl").value.trim(), mode:byId("kinoMode").value, saved_at:nowISO()};
    current.kino.templates.unshift(entry);
    current.updated=nowISO(); await ghPutFile(current,"kino: save template");
    renderKinoLists();
  }catch(e){ alert("Fehler Vorlage:\n"+e.message) }
}
function kinoLoadTemplate(i){
  const t=current.kino.templates[i];
  if(!t) return;
  byId("kinoUrl").value=t.url||"";
  byId("playlistUrl").value=t.playlist||"";
  byId("kinoMode").value=t.mode||"60s";
  kinoPreview();
}
async function kinoTemplateRemove(i){
  if(!confirmAction("Vorlage lÃ¶schen?")) return;
  current.kino.templates.splice(i,1);
  current.updated=nowISO(); await ghPutFile(current,"kino: remove template");
  renderKinoLists();
}
async function kinoStartNow(){
  if(!confirmAction("Kino jetzt starten & loggen?")) return;
  await ensureLoaded();
  current.kino.running=true;
  current.kino.history.unshift({url:byId("kinoUrl").value.trim(), start:nowISO()});
  current.updated=nowISO(); await ghPutFile(current,"kino: start now");
  byId("kinoLiveBanner").style.display='block'; byId("kinoLiveBanner").classList.add('blink');
  byId("statusMsg").textContent="Kino gestartet";
}
async function kinoEnd(){
  if(!confirmAction("Kino-Event beenden?")) return;
  await ensureLoaded();
  current.kino.running=false;
  if(current.kino.history.length){ current.kino.history[0].end=nowISO(); }
  current.updated=nowISO(); await ghPutFile(current,"kino: end & log");
  byId("kinoLiveBanner").style.display='none'; byId("kinoLiveBanner").classList.remove('blink');
  byId("statusMsg").textContent="Kino beendet";
}
async function kinoReplay(i){
  if(!confirmAction("Diese Sendung erneut starten?")) return;
  const h=current.kino.history[i]; if(!h) return;
  byId("kinoUrl").value=h.url||"";
  kinoPreview(); await kinoStartNow();
}
async function kinoHistToArchive(i){
  if(!confirmAction("In Kino-Archiv verschieben?")) return;
  const h=current.kino.history.splice(i,1)[0]; if(!h) return;
  current.kino.archive.unshift({...h, archived_at:nowISO()});
  current.updated=nowISO(); await ghPutFile(current,"kino: hist->arch");
  renderKinoLists();
}
async function kinoArchiveRestore(i){
  if(!confirmAction("Aus Kino-Archiv zurÃ¼ckholen?")) return;
  const a=current.kino.archive.splice(i,1)[0]; if(!a) return;
  current.kino.history.unshift({...a}); delete current.kino.history[0].archived_at;
  current.updated=nowISO(); await ghPutFile(current,"kino: arch->hist");
  renderKinoLists();
}
async function kinoArchiveRemove(i){
  if(!confirmAction("Archiv-Eintrag entfernen?")) return;
  current.kino.archive.splice(i,1);
  current.updated=nowISO(); await ghPutFile(current,"kino: arch remove");
  renderKinoLists();
}

/* ===== Musik ===== */
function isAudioName(name){ return /\.(mp3|ogg|wav)$/i.test(name) }
function renderMusic(){
  byId("countMusicLib").textContent=current.music.library.length;
  byId("countMusicActive").textContent=current.music.active.length;

  byId("musicLib").innerHTML=current.music.library.map((u,i)=>`
    <div class="item">
      <span class="badge">${i+1}</span>
      <div class="url" title="${u}">${shortUrl(u)}</div>
      <div class="row">
        <button class="btn small gold" onclick="musicPreview('${encodeURIComponent(u)}')">â–¶ï¸</button>
        <button class="btn small teal" onclick="musicLibToActive(${i})">ï¼‹ Aktiv</button>
        <button class="btn small ghost" onclick="musicLibRemove(${i})">ğŸ—‘</button>
      </div>
    </div>`).join("");

  byId("musicActive").innerHTML=current.music.active.map((u,i)=>`
    <div class="item">
      <span class="badge">${i+1}</span>
      <div class="url">${shortUrl(u)}</div>
      <div class="row">
        <button class="btn small gold" onclick="musicPreview('${encodeURIComponent(u)}')">â–¶ï¸</button>
        <button class="btn small ghost" onclick="musicMoveUp(${i})">â–²</button>
        <button class="btn small ghost" onclick="musicMoveDown(${i})">â–¼</button>
        <button class="btn small blue" onclick="musicActiveToArchive(${i})">ğŸ“¦ Archiv</button>
      </div>
    </div>`).join("");

  const A=current.music.archived;
  byId("musicArch").innerHTML=A.length? A.map((o,i)=>`
    <div class="item">
      <span class="badge">${i+1}</span>
      <div class="url">${shortUrl(o.url)} <span class="muted">Â· ${new Date(o.archived_at).toLocaleString()}</span></div>
      <div class="row">
        <button class="btn small teal" onclick="musicRestore(${i})">â†©ï¸</button>
        <button class="btn small ghost" onclick="musicArchRemove(${i})">ğŸ—‘</button>
      </div>
    </div>`).join(""):`<div class="muted">Noch nichts archiviert.</div>`;
}
async function musicAddLib(){
  await ensureLoaded();
  const u=byId('newMusicUrl').value.trim(); if(!u) return alert('Bitte Audio-URL angeben.');
  if(!current.music.library.includes(u)) current.music.library.push(u);
  current.updated=nowISO(); await ghPutFile(current,"music: add lib"); renderMusic();
}
async function musicAddActive(){
  await ensureLoaded();
  const u=byId('newMusicUrl').value.trim(); if(!u) return alert('Bitte Audio-URL angeben.');
  if(!current.music.active.includes(u)) current.music.active.push(u);
  if(!current.music.library.includes(u)) current.music.library.push(u);
  current.updated=nowISO(); await ghPutFile(current,"music: add active"); renderMusic();
}
async function musicLibToActive(i){
  await ensureLoaded();
  const u=current.music.library[i]; if(!current.music.active.includes(u)) current.music.active.push(u);
  current.updated=nowISO(); await ghPutFile(current,"music: lib->active"); renderMusic();
}
async function musicLibRemove(i){
  if(!confirmAction("Audio aus Bibliothek entfernen?")) return;
  current.music.library.splice(i,1); current.updated=nowISO(); await ghPutFile(current,"music: lib remove"); renderMusic();
}
function musicMoveUp(i){ if(i<=0) return; const a=current.music.active; [a[i-1],a[i]]=[a[i],a[i-1]]; ghPutFile(current,"music: move up").then(renderMusic) }
function musicMoveDown(i){ const a=current.music.active; if(i>=a.length-1) return; [a[i+1],a[i]]=[a[i],a[i+1]]; ghPutFile(current,"music: move down").then(renderMusic) }
async function musicActiveToArchive(i){
  if(!confirmAction("Audio in Archiv verschieben?")) return;
  const u=current.music.active[i]; current.music.archived.unshift({url:u,archived_at:nowISO()}); current.music.active.splice(i,1);
  current.updated=nowISO(); await ghPutFile(current,"music: active->arch"); renderMusic();
}
async function musicRestore(i){
  const u=current.music.archived[i].url; if(!current.music.active.includes(u)) current.music.active.push(u);
  current.music.archived.splice(i,1); current.updated=nowISO(); await ghPutFile(current,"music: arch->active"); renderMusic();
}
async function musicArchRemove(i){
  if(!confirmAction("Archiv-Eintrag entfernen?")) return;
  current.music.archived.splice(i,1); current.updated=nowISO(); await ghPutFile(current,"music: arch remove"); renderMusic();
}
function musicPreview(enc){ byId('audioPrev').src=decodeURIComponent(enc); byId('audioPrev').play(); }
function musicPrevStop(){ byId('audioPrev').pause(); byId('audioPrev').currentTime=0; }

/* Scan & Upload */
async function scanRepoMusic(){
  try{
    await ensureLoaded();
    const deep = byId('scanAll').checked;
    const primary = await ghListPath('assets/music').catch(()=>[]);
    let files = primary.filter(f=>f.type==='file' && isAudioName(f.name));

    if(deep){
      const all = await ghListRecursive('');
      files = all.filter(f=>f.type==='file' && isAudioName(f.name));
    }else{
      const root = await ghListPath('').catch(()=>[]);
      files = files.concat(root.filter(f=>f.type==='file' && isAudioName(f.name)));
    }

    let added=0;
    for(const f of files){
      const url = toPagesUrl(f.path);
      if(!current.music.library.includes(url)){ current.music.library.push(url); added++; }
    }
    current.updated=nowISO();
    await ghPutFile(current, `music: import ${added} from repo`);
    renderMusic();
    alert(added ? `${added} Audio-Datei(en) Ã¼bernommen.` : 'Keine neuen Audio-Dateien gefunden.');
  }catch(e){ alert('Fehler (Repo scannen):\n'+e.message) }
}
function sanitizeName(n){ return n.replace(/[^a-z0-9._-]+/gi,'_') }
byId('btnUpload').addEventListener('click',()=>byId('musicFile').click());
byId('musicFile').addEventListener('change', async (ev)=>{
  try{
    await ensureLoaded();
    const f=ev.target.files[0]; if(!f) return;
    const name=sanitizeName(f.name);
    const path=`assets/music/${name}`;
    const meta=await ghGetMeta(path);
    if(meta && !confirmAction(`Datei existiert bereits:\n${path}\nÃœberschreiben?`)){ ev.target.value=''; return; }

    const buf=await f.arrayBuffer();
    let bin=''; const bytes=new Uint8Array(buf); for(let i=0;i<bytes.byteLength;i++) bin+=String.fromCharCode(bytes[i]);
    const b64=btoa(bin);

    await ghUploadBinary(path, b64, `music upload: ${name}`, meta?.sha);
    const url=toPagesUrl(path);
    if(!current.music.library.includes(url)) current.music.library.push(url);
    current.updated=nowISO();
    await ghPutFile(current,'music: add uploaded');
    renderMusic();
    alert(`Hochgeladen & Ã¼bernommen: ${name}`);
  }catch(e){ alert('Fehler (Upload Musik):\n'+e.message) }
  finally{ ev.target.value='' }
});

/* Verbinden / Laden */
async function connect(){
  GH.owner=byId("ghOwner").value.trim();
  GH.repo=byId("ghRepo").value.trim();
  GH.branch=byId("ghBranch").value.trim();
  GH.path=byId("ghPath").value.trim();
  GH.token=byId("ghToken").value.trim();

  byId("connStatus").textContent="Verbinde â€¦"; byId("btnReload").disabled=true;
  try{
    const ping=await fetch(`https://api.github.com/repos/${GH.owner}/${GH.repo}`,{headers:ghHeaders()});
    if(!ping.ok) throw new Error(`Repo nicht erreichbar (${ping.status})`);
    byId("connStatus").innerHTML=`<span class="ok">Verbunden.</span>`;
    byId("btnReload").disabled=false;
    await loadOrInit(); // automatisch laden
  }catch(e){ byId("connStatus").innerHTML=`<span class="err">Fehler: ${e.message}</span>`; }
}
async function loadOrInit(){
  byId("connStatus").textContent="Lade rotator.json â€¦";
  try{
    const r=await ghGetFile();
    if(r.status===404){
      current=defaultData();
      await ghPutFile(current,"init rotator.json");
      byId("connStatus").innerHTML=`<span class="warn">rotator.json neu angelegt.</span>`;
    }else{
      current=r.data; currentSha=r.sha; ensureStruct();
      byId("connStatus").innerHTML=`<span class="ok">rotator.json geladen.</span>`;
    }
    byId("lastLoad").textContent=new Date().toLocaleString();
    renderAll();
  }catch(e){ byId("connStatus").innerHTML=`<span class="err">Fehler: ${e.message}</span>`; }
}
function logout(){
  if(!confirmAction("Verbindung trennen?")) return;
  GH.token=""; byId('ghToken').value="";
  byId("connStatus").innerHTML=`<span class="warn">Abgemeldet.</span>`;
}

/* Events */
byId("btnConnect").addEventListener("click",connect);
byId("btnReload").addEventListener("click",loadOrInit);
byId("btnLogout").addEventListener("click",logout);

byId("btnAddLib").addEventListener("click",addToLibrary);
byId("btnAddActive").addEventListener("click",addDirectToActive);
byId("btnPreviewNew").addEventListener("click",()=>{const u=toEmbed(byId("newUrl").value,current?.hostPref||'auto'); if(!u) return alert("Bitte gÃ¼ltige URL"); previewUrl(encodeURIComponent(u));});
byId("btnStopPreview").addEventListener("click",stopPreview);

byId("btnTestRotate").addEventListener("click",startTestRotate);
byId("btnStopAll").addEventListener("click",stopAllTimers);
byId("btnStartRotation").addEventListener("click",startRotation);
byId("btnPauseRotation").addEventListener("click",pauseRotation);
byId("btnSaveInterval").addEventListener("click",saveInterval);

byId("btnKinoPreview").addEventListener("click",kinoPreview);
byId("btnKinoPrevStop").addEventListener("click",kinoPrevStop);
byId("btnKinoSave").addEventListener("click",kinoSave);
byId("btnKinoAsTemplate").addEventListener("click",kinoAsTemplate);
byId("btnKinoStartNow").addEventListener("click",kinoStartNow);
byId("btnKinoEnd").addEventListener("click",kinoEnd);

byId("btnAddMusicLib").addEventListener("click",musicAddLib);
byId("btnAddMusicActive").addEventListener("click",musicAddActive);
byId("btnPrevMusic").addEventListener("click",()=>{const u=byId('newMusicUrl').value.trim(); if(!u) return alert("URL fehlt"); musicPreview(encodeURIComponent(u));});
byId("btnPrevMusicStop").addEventListener("click",musicPrevStop);
byId("btnScanRepo").addEventListener("click",scanRepoMusic);

/* On-Air initial */
renderOnAir();
</script>
</body>
</html>
