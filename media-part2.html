<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>FSA Admin ¬∑ Media Part 2 (Rota-Style-003)</title>
<style>
  :root{
    --bg:#0b1220; --card:#111827; --muted:#9aa4b2; --txt:#eaf2ff;
    --gold:#d4af37; --teal:#1cc2a0; --red:#e11d48; --blue:#38bdf8;
    --shadow:0 10px 30px rgba(0,0,0,.45); --radius:14px;
  }
  body{margin:0;background:var(--bg);color:var(--txt);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid rgba(212,175,55,.25);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
  .grid{display:grid;gap:16px}
  .g-2{grid-template-columns:1fr 1fr}
  @media (max-width:1020px){.g-2{grid-template-columns:1fr}}
  .title{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .title h2{color:var(--gold);font-size:1.2rem;margin:0}
  .muted{color:var(--muted);font-size:.95rem}
  .hr{height:1px;background:rgba(255,255,255,.1);margin:12px 0}
  label{display:block;margin:8px 0 6px;font-weight:700;color:#dbe3f3}
  input,select{width:100%;padding:10px;border-radius:10px;border:1px solid #334155;background:#0b1325;color:#fff;outline:none}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .btn{padding:10px 14px;border:none;border-radius:10px;font-weight:800;cursor:pointer;box-shadow:var(--shadow)}
  .btn.gold{background:var(--gold);color:#000}.btn.teal{background:var(--teal);color:#001210}
  .btn.blue{background:var(--blue);color:#001018}.btn.red{background:var(--red);color:#fff}
  .btn.ghost{background:transparent;border:1px dashed rgba(255,255,255,.25);color:#cbd5e1}
  .preview{border:2px solid var(--gold);border-radius:12px;overflow:hidden;height:360px;background:#000}
  .stat{display:flex;gap:8px;flex-wrap:wrap;align-items:center;font-size:.92rem}
  .chip{padding:4px 10px;border-radius:999px;background:#0f1a30;border:1px solid rgba(255,255,255,.12);color:#cbe0ff}
  .note{font-size:.9rem;color:#b6c3d6}
  .list{display:grid;gap:10px;margin-top:10px}
  .item{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;background:#0e182b;border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:10px}
  .badge{background:var(--gold);color:#000;border-radius:999px;padding:2px 8px;font-weight:900;font-size:.8rem}
  .url{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#dbeafe}
  .onair{border:1px solid rgba(56,189,248,.35);border-radius:8px}
  .blink{animation:blink 1s infinite}
  @keyframes blink{50%{box-shadow:0 0 0 3px rgba(56,189,248,.25)}}
  .ok{color:#22c55e}.warn{color:#f59e0b}.err{color:#ef4444}
</style>
</head>
<body>
<div class="wrap">

  <!-- GitHub Verbindung -->
  <div class="card">
    <div class="title"><h2>üîë GitHub Verbindung</h2></div>
    <div class="grid g-2">
      <div><label>Owner</label><input id="ghOwner" value="Adler-FSA"></div>
      <div><label>Repo</label><input id="ghRepo" value="FSA-Admin"></div>
      <div><label>Branch</label><input id="ghBranch" value="main"></div>
      <div><label>JSON-Pfad</label><input id="ghPath" value="rotator.json"></div>
      <div style="grid-column:1/-1">
        <label>Personal Access Token (in-memory, geht verloren bei Reload)</label>
        <input id="ghToken" type="text" placeholder="ghp_... (contents:read/write)">
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn gold" id="btnConnect">üîó Verbinden & Laden</button>
      <span id="connStatus" class="note">Bitte Token einf√ºgen und verbinden.</span>
    </div>
  </div>

  <!-- Vorschau & Rotation -->
  <div class="card" style="margin-top:16px">
    <div class="title">
      <h2>üñ• Vorschau & Rotation</h2>
      <div class="muted">Nur Admin-Test ‚Äì Live-LP zieht Werte aus rotator.json</div>
    </div>

    <div class="grid g-2">
      <!-- Left: Player -->
      <div>
        <div class="preview">
          <iframe id="preview" width="100%" height="100%"
                  allow="autoplay; encrypted-media; picture-in-picture"
                  referrerpolicy="no-referrer"
                  sandbox="allow-same-origin allow-scripts allow-presentation"
                  style="border:0"></iframe>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn gold" id="btnTestRotate">‚úèÔ∏è Rotationstest (5s)</button>
          <button class="btn ghost" id="btnStopAll">‚èπÔ∏è Test/Rotation beenden</button>
        </div>
        <div class="hr"></div>
        <div class="note">Status: <span id="statusMsg">‚Äî</span></div>
        <div class="note">Jetzt l√§uft: <span id="nowPlaying">‚Äî</span></div>
      </div>

      <!-- Right: Controls -->
      <div>
        <label>Intervall (Sekunden)</label>
        <input id="intervalSec" type="number" min="3" value="60">

        <label style="margin-top:8px">Guard-Zeit (Sekunden) ¬∑ Puffer gegen st√∂rende Overlays</label>
        <input id="guardSec" type="number" min="0" value="2">

        <div class="row" style="margin-top:10px">
          <label style="display:flex;gap:8px;align-items:center">
            <input id="safeMode" type="checkbox" checked>
            <span>Sandbox/Safe-Mode aktiv (empfohlen)</span>
          </label>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn teal" id="btnStartRotation">‚ñ∂Ô∏è Start</button>
          <button class="btn red"  id="btnPauseRotation">‚è∏ Stop</button>
          <button class="btn blue" id="btnSaveInterval">üíæ Intervall merken</button>
        </div>

        <div class="hr"></div>
        <div class="stat">
          <span class="chip">Aktive: <span id="countActive">0</span></span>
          <span class="chip">Intervall: <span id="intervalLabel">60</span>s</span>
          <span class="chip">Guard: <span id="guardLabel">2</span>s</span>
        </div>
        <div class="hr"></div>

        <div class="muted" style="margin-bottom:8px">On-Air-Anzeige</div>
        <div id="activeList" class="list"></div>
      </div>
    </div>
  </div>

  <div class="muted" style="margin:14px 4px">Letztes Laden: <span id="lastLoad">‚Äî</span> ¬∑ Letztes Speichern: <span id="lastSave">‚Äî</span></div>
</div>

<script>
/* ===== Helpers ===== */
const $ = s => document.querySelector(s);
const byId = id => document.getElementById(id);
function shortUrl(u){try{const x=new URL(u);return x.hostname.replace('www.','')+x.pathname+(x.search?'‚Ä¶':'')}catch(e){return u}}
function nowISO(){return new Date().toISOString()}
function toBase64(str){const enc=new TextEncoder().encode(str);let bin="";enc.forEach(b=>bin+=String.fromCharCode(b));return btoa(bin)}
function fromBase64(b64){const bin=atob(b64);const bytes=new Uint8Array(bin.length);for(let i=0;i<bin.length;i++)bytes[i]=bin.charCodeAt(i);return new TextDecoder().decode(bytes)}

function toEmbed(url){
  if(!url) return "";
  let u=url.trim();
  if(/youtu\.be\//i.test(u)){const id=u.split("youtu.be/")[1].split(/[?&]/)[0]; return `https://www.youtube.com/embed/${id}?rel=0&autoplay=1&mute=1&playsinline=1`;}
  if(/youtube\.com\/watch/i.test(u)){const q=new URL(u).searchParams.get("v"); if(q) return `https://www.youtube.com/embed/${q}?rel=0&autoplay=1&mute=1&playsinline=1`;}
  if(/youtube\.com\/embed/i.test(u)) return u;
  if(/vimeo\.com\/\d+/.test(u)){const id=(u.match(/vimeo\.com\/(\d+)/)||[])[1]; if(id) return `https://player.vimeo.com/video/${id}?autoplay=1&muted=1`;}
  if(/player\.vimeo\.com\/video/.test(u)) return u;
  return u;
}

/* ===== GitHub ===== */
let GH={owner:"Adler-FSA",repo:"FSA-Admin",branch:"main",path:"rotator.json",token:""};
let current=null, currentSha="", timer=null, curIdx=0;

function ghHeaders(){ if(!GH.token) throw new Error("Kein Token"); return {"Authorization":"Bearer "+GH.token,"Accept":"application/vnd.github+json","Content-Type":"application/json"};}
async function ghGetFile(){
  const url=`https://api.github.com/repos/${GH.owner}/${GH.repo}/contents/${GH.path}?ref=${GH.branch}`;
  const res=await fetch(url,{headers:ghHeaders()});
  if(res.status===404) return {status:404};
  if(!res.ok) throw new Error(`GET ${res.status}: ${await res.text()}`);
  const j=await res.json(); const content=fromBase64(j.content||"");
  return {status:200,sha:j.sha,data:JSON.parse(content)};
}
async function ghPutFile(data,message){
  const url=`https://api.github.com/repos/${GH.owner}/${GH.repo}/contents/${GH.path}`;
  const body={message:message||"update rotator.json",content:toBase64(JSON.stringify(data,null,2)),branch:GH.branch};
  if(currentSha) body.sha=currentSha;
  const res=await fetch(url,{method:"PUT",headers:ghHeaders(),body:JSON.stringify(body)});
  if(!res.ok) throw new Error(`PUT ${res.status}: ${await res.text()}`);
  const j=await res.json(); currentSha=j.content.sha; byId("lastSave").textContent=new Date().toLocaleString();
}

/* ===== UI Render ===== */
function renderActive(){
  const act=current?.active||[];
  byId("countActive").textContent=act.length;
  byId("intervalLabel").textContent=current?.interval||60;
  byId("guardLabel").textContent=byId("guardSec").value||0;

  byId("activeList").innerHTML=act.map((u,i)=>`
    <div class="item ${i===curIdx?'onair blink':''}">
      <span class="badge">${i+1}</span>
      <div class="url" title="${u}">${shortUrl(u)}</div>
      <div class="row">
        <button class="btn ghost" onclick="previewIndex(${i})">‚ñ∂Ô∏è Vorschau</button>
      </div>
    </div>
  `).join("");
}

/* ===== Player control ===== */
function applySandbox(){
  const iframe = byId("preview");
  if(byId("safeMode").checked){
    iframe.setAttribute("sandbox","allow-same-origin allow-scripts allow-presentation");
  }else{
    iframe.setAttribute("sandbox","allow-same-origin allow-scripts allow-presentation allow-popups allow-forms");
  }
}
function setNowPlaying(u){
  byId("nowPlaying").textContent = `${curIdx+1}/${(current?.active||[]).length} ¬∑ ${shortUrl(u)}`;
}
function showUrl(u){
  applySandbox();
  byId("preview").src = u;
  setNowPlaying(u);
  renderActive();
}
function previewIndex(i){
  if(!current?.active?.length) return;
  curIdx = Math.max(0, Math.min(i, current.active.length-1));
  showUrl(current.active[curIdx]);
}

function stopAll(){
  if(timer) clearTimeout(timer);
  timer=null;
  byId("preview").src="about:blank";
  byId("statusMsg").textContent="gestoppt";
  renderActive();
}

function chainRotate(intervalMs, guardMs){
  const arr=current.active||[];
  if(!arr.length) return stopAll();
  showUrl(arr[curIdx]);
  timer=setTimeout(()=>{
    curIdx = (curIdx+1)%arr.length;
    chainRotate(intervalMs, guardMs);
  }, intervalMs + guardMs);
}

function startTest(){
  stopAll();
  if(!current?.active?.length) return alert("Keine aktiven Videos.");
  byId("statusMsg").textContent="Rotationstest (5s) ‚Ä¶";
  curIdx=0;
  chainRotate(5000, 0);
}

function startRotation(){
  stopAll();
  if(!current?.active?.length) return alert("Keine aktiven Videos.");
  const sec=Math.max(3, parseInt(byId("intervalSec").value||"60",10));
  const guard=Math.max(0, parseInt(byId("guardSec").value||"0",10));
  byId("statusMsg").textContent=`Rotation aktiv (${sec}s + Guard ${guard}s)`;
  curIdx=0;
  chainRotate(sec*1000, guard*1000);
}
function pauseRotation(){
  if(timer){ clearTimeout(timer); timer=null; byId("statusMsg").textContent="Rotation pausiert"; }
}

/* ===== Save interval ===== */
async function saveInterval(){
  try{
    if(!current) return;
    const sec=Math.max(3, parseInt(byId("intervalSec").value||"60",10));
    current.interval=sec; current.updated=nowISO();
    await ghPutFile(current,"update: interval");
    byId("intervalLabel").textContent=sec;
    byId("statusMsg").textContent="Intervall gespeichert";
  }catch(e){ alert("Fehler beim Speichern des Intervalls:\n"+e.message); }
}

/* ===== Connect & Load ===== */
async function connect(){
  GH.owner=byId("ghOwner").value.trim();
  GH.repo =byId("ghRepo").value.trim();
  GH.branch=byId("ghBranch").value.trim();
  GH.path  =byId("ghPath").value.trim();
  GH.token =byId("ghToken").value.trim();
  byId("connStatus").textContent="Verbinde ‚Ä¶";
  try{
    const ping=await fetch(`https://api.github.com/repos/${GH.owner}/${GH.repo}`,{headers:ghHeaders()});
    if(!ping.ok) throw new Error(`Repo nicht erreichbar (${ping.status})`);
    const r=await ghGetFile();
    if(r.status===404) throw new Error("rotator.json nicht gefunden (erst Part 1 ausf√ºhren)");
    current=r.data; currentSha=r.sha;
    byId("intervalSec").value=current.interval||60;
    byId("connStatus").innerHTML=`<span class="ok">rotator.json geladen.</span>`;
    byId("lastLoad").textContent=new Date().toLocaleString();
    curIdx=0;
    renderActive();
  }catch(e){
    byId("connStatus").innerHTML=`<span class="err">Fehler: ${e.message}</span>`;
  }
}

/* ===== Events ===== */
byId("btnConnect").addEventListener("click",connect);
byId("btnTestRotate").addEventListener("click",startTest);
byId("btnStopAll").addEventListener("click",stopAll);
byId("btnStartRotation").addEventListener("click",startRotation);
byId("btnPauseRotation").addEventListener("click",pauseRotation);
byId("btnSaveInterval").addEventListener("click",saveInterval);
byId("safeMode").addEventListener("change",()=>applySandbox());
byId("guardSec").addEventListener("change",()=>{byId("guardLabel").textContent=byId("guardSec").value||0;});
</script>
</body>
</html>
