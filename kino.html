<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>FSA Â· Kino</title>
<style>
  :root{--bg:#0b1220;--card:#111827;--txt:#eaf2ff;--gold:#d4af37;--muted:#9aa4b2}
  body{margin:0;background:var(--bg);color:var(--txt);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1100px;margin:20px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid rgba(212,175,55,.3);border-radius:14px;padding:16px}
  h1,h2,h3{margin:0 0 10px}
  .muted{color:var(--muted)}
  .grid{display:grid;gap:16px;grid-template-columns:2fr 1fr}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  #playerBox{aspect-ratio:16/9;background:#000;border:2px solid var(--gold);border-radius:12px;overflow:hidden}
  iframe{width:100%;height:100%;border:0}
  ul{margin:8px 0 0 18px}
  .live{display:inline-block;margin-left:8px;padding:3px 8px;border-radius:999px;background:#16a34a;color:#041b10;font-weight:800}
</style>
</head>
<body>
<div class="wrap">
  <h1>ðŸŽ¬ FSA Kino <span id="liveTag" class="live" style="display:none">LIVE</span></h1>
  <div class="muted" id="metaLine">LÃ¤dt â€¦</div>
  <div class="grid" style="margin-top:12px">
    <div class="card" id="playerBox">
      <!-- Player wird per JS eingesetzt -->
    </div>
    <div class="card">
      <h3>Programm</h3>
      <div id="progTitle" class="muted" style="margin-bottom:6px"></div>
      <ul id="progList"></ul>
    </div>
  </div>
</div>

<!-- APIs fÃ¼r Auto-Weiter -->
<script src="https://www.youtube.com/iframe_api"></script>
<script src="https://player.vimeo.com/api/player.js"></script>
<script>
const RAW_JSON_URL = './rotator.json'; // gleicher Host (GH Pages)

let cfg=null, queue=[], playMode='interval', hostPref='auto';
let curIndex=0, ytPlayer=null, vmPlayer=null, live=false;

function short(u){try{const x=new URL(u);return x.hostname.replace('www.','')+x.pathname;}catch(e){return u}}

async function loadJSON(){
  const res = await fetch(RAW_JSON_URL, {cache:'no-store'});
  if(!res.ok) throw new Error('rotator.json nicht erreichbar');
  cfg = await res.json();
}

function fillProgram(){
  const k = cfg.kino||{};
  const prog = (k.program && Array.isArray(k.program.items) && k.program.items.length)? k.program : null;

  if(prog){
    queue = prog.items.map(it=>({url:it.url, title:it.title||short(it.url)}));
    playMode = (prog.playMode||'full');
    byId('progTitle').textContent = prog.title||'';
  }else if(k.url){
    queue = [{url:k.url, title:short(k.url)}];
    playMode = (k.mode==='full'?'full':'interval');
    byId('progTitle').textContent = '';
  }else{
    queue = [];
  }

  const ul = byId('progList');
  ul.innerHTML = queue.length? queue.map((it,i)=>`<li>${i+1}. ${it.title}</li>`).join('') : '<li class="muted">Kein Programm hinterlegt.</li>';

  const meta = [];
  if(k.startISO){ meta.push('Start: '+new Date(k.startISO).toLocaleString()); }
  if(queue.length){ meta.push('BeitrÃ¤ge: '+queue.length); }
  byId('metaLine').textContent = meta.join(' Â· ') || 'â€”';
}

function byId(id){return document.getElementById(id)}

function toEmbed(u){
  if(/youtu\.be\//i.test(u)){const id=u.split('youtu.be/')[1].split(/[?&]/)[0];return {host:'youtube', id}}
  if(/youtube\.com\/watch/i.test(u)){const q=new URL(u).searchParams.get('v'); if(q) return {host:'youtube', id:q}}
  if(/youtube\.com\/embed\/([^?]+)/i.test(u)){return {host:'youtube', id:u.match(/embed\/([^?]+)/i)[1]}}
  if(/vimeo\.com\/(\d+)/i.test(u)){return {host:'vimeo', id:u.match(/vimeo\.com\/(\d+)/i)[1]}}
  if(/player\.vimeo\.com\/video\/(\d+)/i.test(u)){return {host:'vimeo', id:u.match(/video\/(\d+)/i)[1]}}
  if(/zoom\.us|zoom\.com/i.test(u)){return {host:'zoom', url:u}}
  return {host:'generic', url:u}
}

function clearBox(){
  const box = byId('playerBox');
  box.innerHTML='';
  if(ytPlayer){try{ytPlayer.destroy()}catch(e){} ytPlayer=null;}
  if(vmPlayer){try{vmPlayer.unload()}catch(e){} vmPlayer=null;}
}

function playIndex(i){
  if(!queue.length) return;
  curIndex = (i<0?0:(i>=queue.length?0:i));

  const info = toEmbed(queue[curIndex].url);
  clearBox();

  if(info.host==='youtube'){
    const div=document.createElement('div'); div.id='ytp'; byId('playerBox').appendChild(div);
    ytPlayer = new YT.Player('ytp',{
      videoId: info.id,
      playerVars:{autoplay:1, rel:0, playsinline:1, mute:0},
      events:{
        'onStateChange': e=>{
          if(e.data===YT.PlayerState.ENDED && playMode==='full'){ playIndex(curIndex+1); }
        }
      }
    });
  }else if(info.host==='vimeo'){
    const iframe = document.createElement('iframe');
    iframe.src=`https://player.vimeo.com/video/${info.id}?autoplay=1`;
    iframe.allow='autoplay; fullscreen; picture-in-picture';
    byId('playerBox').appendChild(iframe);
    vmPlayer = new Vimeo.Player(iframe);
    vmPlayer.on('ended', ()=>{ if(playMode==='full') playIndex(curIndex+1); });
  }else{
    // Zoom oder generisch â€“ ohne End-Event
    const iframe=document.createElement('iframe');
    iframe.src= info.url || queue[curIndex].url;
    iframe.allow='autoplay; fullscreen; picture-in-picture';
    byId('playerBox').appendChild(iframe);
    // kein Auto-Weiter mÃ¶glich
  }
}

function markLive(){
  // Live: wenn im History das letzte Item kein ended_at hat
  const h=(cfg.kino&&cfg.kino.history)||[];
  live = !!h.find(x=>!x.ended_at);
  byId('liveTag').style.display = live?'inline-block':'none';
}

async function init(){
  await loadJSON();
  fillProgram();
  markLive();
  if(queue.length) playIndex(0);
}

// YouTube API ruft diese globale Funktion auf:
function onYouTubeIframeAPIReady(){ /* noop, Player wird dynamisch erstellt */ }

init();
</script>
</body>
</html>
